name: "[push.paths] Compile & PR"

on:
  push:
    branches: [ "main" ]
    paths:
      - "EnvObfuscator/**/*.cs"
      - "FinalEnumGenerator/**/*.cs"
  #pull_request:
  #  branches: [ "main" ]
  #release:
  #  types: [ published ]
  workflow_call:
  workflow_dispatch:

permissions:
  id-token: write  # enable GitHub OIDC token issuance for this job
  contents: write
  pull-requests: write
env:
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}


jobs:

  test:
    uses: ./.github/workflows/test.yml

  compile:
    needs: test
    if: success()

    #strategy:
    #  matrix:
    #    configuration: [Debug, Release]

    runs-on: ubuntu-latest   # tip: runs-on can use ${{ matrix.<name> }}

    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5      # v4.3.1
      - uses: actions/setup-dotnet@67a3573c9a986a3f9c594539f4ab511d57bb3ce9  # v4.3.1
        with:
          dotnet-version: 10.x.x

      - run: |
          OUTDIR=./Compiled

          dotnet run --project cli -c Release -- build \
            --unity --merge \
            --force --output $OUTDIR \
            "FinalEnumGenerator/*.cs" "EnvObfuscator/*.cs"  # enquote to prevent expanding


          ### Git work ####

          if [ "${{ github.event_name }}" == "release" ]; then
            REF="${GITHUB_REF#refs/tags/}"
          else
            REF="$(date +%Y%m%d-%H%M)"
          fi

          TITLE="[bot] Compiled Generators ($REF)"
          BRANCH="bot/update-compiled-$(date +%Y%m%d-%H%M%S)"

          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git checkout -b "$BRANCH"
          git add -f $OUTDIR

          if git diff --cached --quiet; then
            echo "No changes, skip PR"
            exit 0
          fi

          git commit -m "$TITLE"
          git push origin "$BRANCH"

          gh pr create \
            --base main \
            --head "$BRANCH" \
            --title "$TITLE" \
            --body "$TITLE"


      ################################
      #  NUGET (.nuspec + dll)
      - name: Trusted Publishing (id-token permission required)
        uses: NuGet/login@v1
        id: login  # --> ${{ steps.login.outputs.NUGET_API_KEY }}
        with:
          user: ${{ secrets.NUGET_LOGIN }}

      - name: Pack (.nuspec + dll)
        run: |
          dotnet pack Compiled/EnvObfuscator.nuspec      -o nuget-pack
          dotnet pack Compiled/FinalEnumGenerator.nuspec -o nuget-pack

      - name: Push to NuGet
        run: |
          dotnet nuget push "nuget-pack/*.nupkg" \
            -k ${{ steps.login.outputs.NUGET_API_KEY }}  \
            -s https://api.nuget.org/v3/index.json \
            --timeout 60 \
            --skip-duplicate
